---
layout: post
title: "群晖DSM系统“套件法”安装8156B芯片网卡驱动"
date: 2021-06-12 
description: "8156B几乎支持近5年的所有群晖机型"
tag: 群晖 DSM 黑群晖 网卡 2.5G 8156B
---
# 比前言更重要的话
摆在2.5G局域网升级最前面的拦路虎就是驱动安装问题，为此我花费非常多的时间与精力来推动认知，写教程、直播、做视频，更多的时候是在做一对一的交流，把自己搞得很累。所以我希望您在决定购入2.5G网卡之前先通过我的文字或视频教程搞定驱动！**驱动可以事先安装，不一定要插上网卡，搞定了驱动再买不迟。**

# 前言
此教程在热心的客户帮助下，一直在迭代更新，目前您看到的是第五版。

我强烈建议您看完教程，一来这是很多玩家智慧的结晶；二来我一直认为折腾硬件和谈恋爱是一个道理，其中的过程是最美妙，成功驾驭后，获得的满足感是无可替代的。

教程的篇幅看起来比较长，但是请不要胆怯，我只是在玩家们的帮助下将50个字延展到了这么长，为的是让每一个过来的玩家都能看懂并且可操作，所以事无巨细稍显啰嗦，在您之前，已经有五百人成功让群晖安装了2.5G网卡（数据源自店内销售统计，因为教程是开放的，实际人数应该大于这个数字），仔细的对照操作，成功是确定性事件。

![20210908092118](https://user-images.githubusercontent.com/85718974/132430593-1a942122-6613-4f24-b966-6a55e9728f02.jpg)

**发问前请先看完教程**

1.教程**支持白群晖、黑群晖**；支持大部分ARM处理器的群晖；

2.开始教程前，请先确定您的DSM系统的版本，可以支持的是DSM6.2.x和DSM7.x.x，目前不支持DSM6.1及更早系统！如果您的系统版本不支持，请升级，升级不会破坏数据；

3.有些早期ARM型号比如DS218Play，暂时没有支持DSM7.0的驱动，请降级，降级亦不会破坏数据。

# 零. 准备工作
1. 无需插上网卡;
2. 既然无需插入网卡，那么网线自然是连接到群晖自带的网卡上；
3. 找到群晖WEB的管理ip（在路由器里找连接设备或者用群晖的软件“[Synology Assistant](https://pan.chiphello.com:40272/黑群晖/群晖助手-7.0-50029.exe)”）

# 一.下载驱动文件

感谢由Github大神@[bb-qq](https://github.com/bb-qq) 提供驱动文件，目前他还在维护这个项目。

下载地址：
[Releases · bb-qq/r8152 (github.com)](https://github.com/bb-qq/r8152/releases)

打开之后，可以看到如下界面：

<img width="633" alt="bbqq" src="https://user-images.githubusercontent.com/85718974/131463003-88d48aa4-c12c-4693-9ed4-524df7bc3b9c.png">

## 这里分为2种情况：
在群晖的控制面板种的“更新和还原”里找到机器型号和DSM版本，如下图：

<img width="454" alt="系统更新" src="https://user-images.githubusercontent.com/85718974/131467612-78016e2f-d8d4-4108-a174-e7e7bf223fc4.png">


### 如果DSM版本是6.2.X
请下载2.15.0-1 或者 2.14.0-3 这种无后缀的条目。

### 如果已经升级到DSM7.X.X
请下载2.15.0-3 DSM7 或者 2.15.0-2 DSM7.0 这种后缀含有DSM7.0的条目。

## 找到驱动

<img width="473" alt="assets" src="https://user-images.githubusercontent.com/85718974/131465008-bf3b36ef-0b1a-4129-8fb0-ef1512b28734.png">

在需要下载的版本下方找到“Assets”，点开之后会出现一个列表。

<img width="847" alt="bbqq列表" src="https://user-images.githubusercontent.com/85718974/131464945-b79b3d38-c6b3-401e-892a-1081ab960d09.png">


列表里面有很多驱动，该下载哪一个呢？请参照下方的表格：

<img width="712" alt="群晖对照表v2-tb" src="https://user-images.githubusercontent.com/85718974/126022457-602b9dff-42ff-48f6-b1cf-1bb2934a063f.png">

如果您的机器没在此表格内，您也可以去下方群晖官网查询

```
快捷键查询：Ctrl+F
```

[What kind of CPU does my Synology NAS have? - Synology Knowledge Center](https://kb.synology.com/en-global/DSM/tutorial/What_kind_of_CPU_does_my_NAS_have)

比如您的机器是DS918+，根据在官网查询的结果，如下图：
<img width="791" alt="机器型号" src="https://user-images.githubusercontent.com/85718974/131466461-2426834e-709a-4c3f-93a0-9c5069b95e46.png">

可以得知DS918+的CPU代号为“Apollolake”，所以相应的要下载r8152-apollolake-2.15.0-1.spk这个驱动

**虽然文件名r8152好像是只支持RTL8152芯片，不过经过测试同样支持RTL8153、RTL8156、RTL8156B芯片。**

下载好的驱动我们先放一边，不要安装不要安装不要安装！

**发问前请先看完教程**

# 二.用SSH登录群晖

## 1.开启群晖的SSH服务
登录群晖→控制面板→高级模式→终端机和SNMP→启动SSH功能
<img width="747" alt="打开群晖的ssh" src="https://user-images.githubusercontent.com/85718974/122698985-13354280-d27b-11eb-8221-6fa61017cad9.png">


## 2.开启电脑的SSH服务

MacOS、Linux系统无需操作

Windows系统：Windows设置→应用→应用和功能→可选功能→添加功能→添加Openssh服务

## 3.SSH登录群晖操作

MacOS、Linux系统可以直接使用“终端”

Windows系统：cmd打开“命令提示符”

输入ssh 你的群晖用户名@群晖局域网地址(举例用户名为huahua、局域网地址为192.168.1.129)：

```
ssh huahua@192.168.1.129
```
**注意：这里输入的是群晖的用户名！不是QuickConnect ID!**

回车之后会出现如下字符：
```
The authenticity of host '192.168.1.129 (192.168.1.129)' can't be established.
ECDSA key fingerprint is SHA256:Y7aQyGomZWRyGjHEmv2tf16HKRt9/yjOiT0rQg7NV3U.
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```
问你yes不yes，当然要yes了！
yes之后回车输入群晖登录密码(输入的时候没有光标没有提示什么都没有不要以为是键盘坏了哦)

登录成功后输入sudo -i 获得root权限

```
sudo -i
```

回车之后再次输入群晖登录密码，回车。
光标的前面如果变成了 root@XXXX:~# （XXXX为你的机器名）则可以进入下一步。

# 三.安装驱动

## 分为两种情况：

### 如果DSM版本是6.2.X
登录到群晖的WEB界面，打开套件中心，手动安装我们之前下载的spk驱动文件。
<img width="1163" alt="20210612133823" src="https://user-images.githubusercontent.com/85718974/121766411-2dd53080-cb84-11eb-9c2e-b87d1d1d9cef.png">

### 如果已经升级到DSM7.X.X
登录到群晖的WEB界面，打开套件中心，手动安装我们之前下载的spk驱动文件。

这个驱动安装后会出错，如下图（感谢@joshua_zhu_99提供图片素材）

![20210907225851](https://user-images.githubusercontent.com/85718974/132369567-a9f96b77-696d-4665-8d0e-7db03bfca6bd.jpg)

我们只需要SSH登录到群晖执行一行神奇的命令即可。

```
sudo install -m 4755 -o root -D /var/packages/r8152/target/r8152/spk_su /opt/sbin/spk_su
```

## 还没完呢？别急吼吼的关闭教程去重启。
如果您的机器是DS3615xs、DS3617xs等含有4个或4个以上的网口的型号，请跳过第四大点直接看第五大点；

如果您的机器是DS918+、218j等只有1到2个网口的型号，请继续往下执行教程，一条都不要落下。

**发问前请先看完教程**

# 四.修改网卡个数

很多朋友的机器驱动不了都是这一步的问题。

群晖的某些机型如DS2xx、4xx、7xx、9xx不支持超过2个网卡，那么新增的这个USB网卡自然是不能识别（有些机型可以识别但是灰色无法激活使用），那么我们现在需要通过SSH在Linux命令行下来修改最高支持的网卡数量。注意，DS3615xs、DS3617xs等机型可以忽略这一步，其本身支持更多的网卡。

我们要做的是用前面提到的SSH登录到群晖然后修改2个文件

## 文件1：在命令行下输入下面的代码（可复制）
```
vi /etc.defaults/synoinfo.conf
```

方向键↓滚屏，在倒数46行左右找到如下字段

> ```text
> maxlanport=“2”
> ```

按“i”进入编辑模式，把第三行maxlanport=“2”中的2修改成比2大的数字（比如6），取决于您想添加几块网卡。

修改完成后按下Esc键退出，输入

```
:wq
```
<img width="734" alt="wq保存界面" src="https://user-images.githubusercontent.com/85718974/122699016-23e5b880-d27b-11eb-878d-357b8c073f46.png">

上面的代码是强制性写入文件并退出的意思，不会有提示符让你输入，直接键盘上敲出来就好。

## 文件2：
```
vi /etc/synoinfo.conf
```

和文件1的操作一样，找到maxlanport=“2”这个字段，按“i”进入编辑模式，修改成和前面一样的数量（在81%位置左右）。

修改完成后按下Esc，输入:wq保存并退出。

# 五.修改脚本等待时间
SSH登录群晖，输入下面代码（可复制）

```
vi /var/packages/r8152/scripts/start-stop-status
```

![20210829215851](https://user-images.githubusercontent.com/85718974/131475531-07ee6558-e161-410b-8a3a-eea533b4010d.jpg)
如果出现了这个画面，请选择“E”，这样就进入了编辑模式。

按方向键↓滚屏，找到有个含有“sleep 10”的语句，按“i”进入编辑模式，将其修改成“sleep 30”。

修改这个数字的意义是告诉系统启动之后延迟30秒启动网卡驱动，如果您的机器配置嗷嗷叫，可以适当把时间改短一点，白群晖老老实实改成30吧。

修改完成后按下Esc键退出，输入

```
:wq
```

把所有步骤都执行之后重启，等待几分钟，顺利的话，大功告成！
<img width="1017" alt="20210612133822" src="https://user-images.githubusercontent.com/85718974/121766420-3d547980-cb84-11eb-89fd-7db63ddd4d28.png">

# 六.并不顺利，重启后不识别
排查问题：
## 1.是否插着网卡重启？
群晖对热插拔支持不好，装好驱动后需要插着网卡的状态重启一次。
## 2.重启还是没有，但是关了再开一次套件就有了？
问题出在有个脚本的等待时间不够，我们要SSH登录上去修改一个参数，请看第五大点。
## 3.还是不行？您的机型是DS2xx+、DS4xx、DS9xx ？
有些机型的默认配置参数只能支持1-2个网卡，增加的网卡当然识别不了，需要修改网卡数量的参数，请看第四大点。
## 4.仍有问题？
那么属于疑难杂症了，请参阅：[https://flatworm-unique.chiphello.com/2021/06/a-knotty-problem-2.5g/](https://flatworm-unique.chiphello.com/2021/06/a-knotty-problem-2.5g/)
