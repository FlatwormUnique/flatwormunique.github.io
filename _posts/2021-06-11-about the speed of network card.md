---
layout: post
title: 關於2.5G網卡顯示或測速不正常的排查
date: 2021-06-11
tags: 2.5g 网卡 测速 排查
---
# 前言
此文檔在玩家們幫助下不斷迭代，目前是第四版。

## 排查前我們先說兩個DIY排查故障的思路
### 1. 最小化系統

比如電腦不亮了，那麼我們的第一反應是什麼？卸掉內存條，用橡皮擦一擦金手指。如果還不亮呢？

把顯卡聲卡網卡陣列卡採集卡等板卡全部拔掉；攝像頭麥克風等外設也一一去除；內存如果有幾條也只留下一條。那麼這種只保留了供電、主板、CPU、內存、核顯的系統就叫做最小化系統。那具體這麼查找原因另開篇再說。

換到網絡這一塊也是一樣的，比如本篇的重點-網速異常，也請拋開虛擬機、拋開軟路由，拋開花里胡哨的組網方式，用硬件路由器或者交換機搭建最簡單的系統進行測試。
![最小化系統](https://user-images.githubusercontent.com/85718974/140629823-0d7af2b8-3e3b-46c7-aa3b-bc9f3e00bf72.jpg)


### 2. 替換法

比如網卡插在NAS上工作不正常，你會怎麼操作？我一般會讓您先把網卡插到電腦上，看看網卡工作是否正常，這就叫做替換法。

如果您有2個網卡，網卡A不正常。我會讓您把網卡B插上去，看是否正常，這也叫做替換法。

兩種方法請在後面的具體操作中合理利用。

展開說之前先了解幾個關鍵數據：2.5G網卡的理論速度是2500Mbps，也是就是312MB/s，各種損耗之後的極限速度是282MB/s（打開巨幀的狀態是295MB/s）。


# 一.不識別
這種問題就是插上去沒反應，或者有點什麼反應，但是網卡並沒有出現
## 沒有安裝驅動
尤其請使用Windows系統的用戶注意，一定要安裝驅動，說Windows免驅的都是不負責任的。
請參考資料：[https://fu.chiphello.com/2021/06/usb2.5g-installation-instruction/](https://fu.chiphello.com/2021/06/usb2.5g-installation-instruction/)


# 二.識別成千兆或者百兆網卡

## 是否接入正確的USB接口 
### 是插在Usb3.0接口上嗎
USB3.0接口的理論速度是5Gbps，由於USB3.0是8b/10b編碼也就是說每10位數據裡面，只有8位是真實數據，另2位是防止數據出錯的校驗位，所以其理論速度是500MB/s，覆蓋了2.5G網卡的理論速度，但是如果你一個不小心把網卡插到了USB2.0接口上，系統會識別為千兆或者百兆網卡。又因為USB2.0的速度是480Mbps，除去協議開銷理論速度是53.3MB/s，那麼就無法發揮這個網卡的威力了，這個接口的速度會死死的限制USB2.5G網卡速度不會超過理論速度。

這裡說2個特例：
1. 蝸牛星際主板，只有一個真正的USB3.0接口，如下圖標註所示。
![a款主板](https://user-images.githubusercontent.com/85718974/140630066-794c20b2-0020-4dec-ba77-5ff72d59c45c.jpg)

2. 蝸牛星際B款雙千兆（82583芯片）沒有USB3.0接口，沒有！

### 有通過Tpye-C轉USB-A的接頭嗎
市售的C-A的轉接器有兩種，一種裡面有個VL1604之類多路復用芯片，正插反插皆可；一種是非「雙面」的轉接器，一面能跑USB 3.0，另一面只能跑USB 2.0。如果你發現識別不正確，可以嘗試換個面插。

## 網線的鍋-是8芯線纜嗎

質量好的5類線跑萬兆電口都沒什麼壓力，更別提2.5G了。但是我知道很多家庭裝修的時候忽略了弱電的走線，後期裝寬帶的工作人員無奈只能把一條8芯網線破開做成2個水晶頭的情況，如下圖：

![shuijingtou.jpg](/images/posts/networkcard/shuijingtou.jpg)

像這種情況，您基本和高速的局域網無緣了，這種4芯的水晶頭連接的設備一律只能握手到百兆帶寬，實際速度充其量12.5MB/s。

既然都說到這裡了，我也提供給這部分朋友一個方案，把這條破開的線還原成一個水晶頭，用無線方案比如UBNT或者Mesh組網。

## 您的路由器或交換機有2.5G端口且與網卡連接的是2.5G端口

現今家用路由器/交換機一般都是千兆接口，這個接口的理論速度是125M/s，作為極客的您當然不是一般人，我默認了您會知道，將2.5G網卡連接到千兆的路由器或交換機只會握手千兆帶寬，即顯示1000Mbps。

這裡說明另一種可能，ax6000、ax86u等WIFI6路由器，只有一個2.5G口，如果：
#### 2.5G網卡連接到千兆端口
握手千兆帶寬，測試速度也是千兆速度。
#### 2.5G網卡連接到2.5G端口
握手2.5G帶寬，測試速度還是千兆速度。

為什麼？不管連入2.5G端口的網卡是NAS的還是PC的，都會有另一個設備無奈只能接入千兆端口，這個地方就是俗稱的瓶頸！

這裡我提供2個解決方案：

方案a：目前最便宜的非網管型2.5G交換機，TP-Link SH1005 和 SH1008 。

方案b：在有NAS情況下，把電腦的2.5G和NAS的2.5G口直連，然後在NAS上，把2.5G端口和本身的千兆口做橋接，讓電腦通過NAS上到廣域網，同時也有了內網2.5G的速度，參考[群暉橋接教程](https://fu.chiphello.com/2021/08/Synology-bridging-tutorial/)。

## 驅動BUG
經客戶反映，在某些群暉的機器上出現了最新版本的驅動不正常的情況，安裝上一個版本的驅動就好啦。


# 三.握手2500Mbps成功，使用異常
這裡的使用異常不是指速度上不去，這個之後再說。這裡的異常指藍屏、死機、斷流、掉驅動等故障。
處理方法：
## 如果是Win系統
請參照[https://fu.chiphello.com/2021/06/usb2.5g-installation-instruction/](https://fu.chiphello.com/2021/06/usb2.5g-installation-instruction/) 安裝驅動。
## 如果是群暉
請安裝上一版本驅動。
## 如果問題依舊
請用前言中的替換法，把網卡插到另一台電腦上測試，以判斷是否網卡本身的問題。

# 四.握手2500Mbps成功，使用無異常，可是速度達不到預期
這個問題相對複雜，我們來有邏輯的直面這個問題。

## 測速的2塊硬盤（上傳盤和下載盤）速度能達到280MB/s嗎
現代的機械硬盤均速在150-220MB/s，如果您的測速落在這個區間，那麼可能是這個原因。
![harddiskspeed.png](/images/posts/networkcard/harddiskspeed.png)

如圖所示，當年，這些都是機械硬盤中的翹楚了，速度都不到200MB/s，如今高端大容量硬盤比如10T氦氣盤、12T西數拆機盤，瞬時的最高速度已經可以上到280MB/s，可是機械硬盤的速度不是恆定的，讀寫內圈的速度小於讀寫外圈的速度，這個道理大家應該懂得吧，所以這個最高速度是讀寫外圈測得的結果，要說均速，是遠小於280MB/s的，這麼一來，機械硬盤速度又成為了瓶頸。

SSD固態硬盤，則不存在這個問題，所以您如果測試極限速度的話，不妨用2塊固態硬盤。當然，用多塊機械硬盤組成Raid 0也是可以的。

## 測速文件請選用封裝好的大文件
因為SSD有尋址損耗，機械盤有大量尋道動作，大量的零碎文件傳輸時不能正確的反映局域網速度。
所以測速請選用藍光原盤、操作系統鏡像等大文件。

## 緩存對速度的影響

<img width="553" alt="緩存影響0" src="https://user-images.githubusercontent.com/85718974/135564564-53e52a4f-0393-4669-8fb5-bf719df613f1.png">

<img width="586" alt="緩存影響" src="https://user-images.githubusercontent.com/85718974/135564548-01d896f5-320a-4f27-92b6-84d4ffb30cd6.png">

先看看上面的圖，局域網內複製的時候，速度從開始穩定在滿速，從某個時點開始斷崖式下跌，之後穩定在125MB/s的速度。

這個問題我們要這樣分析，首先，網卡能跑到280以上的速度，證明網卡本身是好的且驅動成功了，還可以說明交換機和NAS等設備的網絡部分也是沒有問題的；然後我們通過前文來排查，問題也不包含在內。那麼我們着重分析緩存影響的可能性。

![20211001151417 (2)](https://user-images.githubusercontent.com/85718974/135580483-5c930edc-ccc9-46a6-8870-b5993a8806c5.jpg)

如果所示，在我們進行把NAS的數據複製到PC操作時（這裡我們假定PC的硬盤是一塊速度大於280Mbps的SSD），數據會預讀取進入緩存中，當我們進行粘貼操作時，數據會從緩存中開始通過網絡傳輸，緩存可以看作是一塊固態硬盤或者本身就是塊固態硬盤，傳輸的速度自然是非常的快，可以吃透2.5G局域網上限，但是，如果我們的硬盤的讀取速度低於局域網內的速度，那麼緩存里的數據會隨着這個過程的進行而慢慢的減少；當時間來到緩存的數據被取完的那個瞬間，傳輸速度就會出現斷崖式下跌，最後穩定的就是硬盤的真實速度。

反過來，如果PC向NAS中傳輸數據也會有此現象。

## 請採用內網測速的方式

請不要用「測速網、星空極速、電腦管家」等工具來測得局域網速度，這類工具測得是您的電腦到廣域網（電信運營商測速服務器）之間的速度，也就是說運營商給你開了多大的寬帶測得就應該是多少，和這個網卡只有一毛錢的關係。


## 感謝
@wgzeyu 勘誤
