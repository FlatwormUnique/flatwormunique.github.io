---
layout: post
title: 关于2.5G网卡显示或测速不正常的排查
date: 2021-06-11
tags: 2.5g 网卡 测速 排查
---
# 前言
此文档在玩家们帮助下不断迭代，目前是第四版。

## 排查前我们先说两个DIY排查故障的思路
### 1. 最小化系统

比如电脑不亮了，那么我们的第一反应是什么？卸掉内存条，用橡皮擦一擦金手指。如果还不亮呢？

把显卡声卡网卡阵列卡采集卡等板卡全部拔掉；摄像头麦克风等外设也一一去除；内存如果有几条也只留下一条。那么这种只保留了供电、主板、CPU、内存、核显的系统就叫做最小化系统。那具体这么查找原因另开篇再说。

换到网络这一块也是一样的，比如本篇的重点-网速异常，也请抛开虚拟机、抛开软路由，抛开花里胡哨的组网方式，用硬件路由器或者交换机搭建最简单的系统进行测试。
![最小化系统](https://user-images.githubusercontent.com/85718974/140629823-0d7af2b8-3e3b-46c7-aa3b-bc9f3e00bf72.jpg)


### 2. 替换法

比如网卡插在NAS上工作不正常，你会怎么操作？我一般会让您先把网卡插到电脑上，看看网卡工作是否正常，这就叫做替换法。

如果您有2个网卡，网卡A不正常。我会让您把网卡B插上去，看是否正常，这也叫做替换法。

两种方法请在后面的具体操作中合理利用。

展开说之前先了解几个关键数据：2.5G网卡的理论速度是2500Mbps，也是就是312MB/s，各种损耗之后的极限速度是282MB/s（打开巨帧的状态是295MB/s）。

# 一.不识别
这种问题就是插上去没反应，或者有点什么反应，但是网卡并没有出现
## 没有安装驱动
尤其请使用Windows系统的用户注意，一定要安装驱动，说Windows免驱的都是不负责任的。
请参考资料：[https://flatworm-unique.chiphello.com/2021/06/usb2.5g-installation-instruction/](https://flatworm-unique.chiphello.com/2021/06/usb2.5g-installation-instruction/)


# 二.识别成千兆或者百兆网卡

## 是否接入正确的USB接口 
### 是插在Usb3.0接口上吗
USB3.0接口的理论速度是5Gbps，由于USB3.0是8b/10b编码也就是说每10位数据里面，只有8位是真实数据，另2位是防止数据出错的校验位，所以其理论速度是500MB/s，覆盖了2.5G网卡的理论速度，但是如果你一个不小心把网卡插到了USB2.0接口上，系统会识别为千兆或者百兆网卡。又因为USB2.0的速度是480Mbps，除去协议开销理论速度是53.3MB/s，那么就无法发挥这个网卡的威力了，这个接口的速度会死死的限制USB2.5G网卡速度不会超过理论速度。

这里说2个特例：
1. 蜗牛星际主板，只有一个真正的USB3.0接口，如下图标注所示。
![a款主板](https://user-images.githubusercontent.com/85718974/140630066-794c20b2-0020-4dec-ba77-5ff72d59c45c.jpg)

2. 蜗牛星际B款双千兆（82583芯片）没有USB3.0接口，没有！

### 有通过Tpye-C转USB-A的接头吗
市售的C-A的转接器有两种，一种里面有个VL1604之类多路复用芯片，正插反插皆可；一种是非“双面”的转接器，一面能跑USB 3.0，另一面只能跑USB 2.0。如果你发现识别不正确，可以尝试换个面插。

## 网线的锅-是8芯线缆吗

质量好的5类线跑万兆电口都没什么压力，更别提2.5G了。但是我知道很多家庭装修的时候忽略了弱电的走线，后期装宽带的工作人员无奈只能把一条8芯网线破开做成2个水晶头的情况，如下图：

![shuijingtou.jpg](/images/posts/networkcard/shuijingtou.jpg)

像这种情况，您基本和高速的局域网无缘了，这种4芯的水晶头连接的设备一律只能握手到百兆带宽，实际速度充其量12.5MB/s。

既然都说到这里了，我也提供给这部分朋友一个方案，把这条破开的线还原成一个水晶头，用无线方案比如UBNT或者Mesh组网。

## 您的路由器或交换机有2.5G端口且与网卡连接的是2.5G端口

现今家用路由器/交换机一般都是千兆接口，这个接口的理论速度是125M/s，作为极客的您当然不是一般人，我默认了您会知道，将2.5G网卡连接到千兆的路由器或交换机只会握手千兆带宽，即显示1000Mbps。

这里说明另一种可能，ax6000、ax86u等WIFI6路由器，只有一个2.5G口，如果：
#### 2.5G网卡连接到千兆端口
握手千兆带宽，测试速度也是千兆速度。
#### 2.5G网卡连接到2.5G端口
握手2.5G带宽，测试速度还是千兆速度。

为什么？不管连入2.5G端口的网卡是NAS的还是PC的，都会有另一个设备无奈只能接入千兆端口，这个地方就是俗称的瓶颈！

这里我提供2个解决方案：

方案a：目前最便宜的非网管型2.5G交换机，TP-Link SH1005 和 SH1008 。

方案b：在有NAS情况下，把电脑的2.5G和NAS的2.5G口直连，然后在NAS上，把2.5G端口和本身的千兆口做桥接，让电脑通过NAS上到广域网，同时也有了内网2.5G的速度，参考[群晖桥接教程](https://flatworm-unique.chiphello.com/2021/08/Synology-bridging-tutorial/)。

## 驱动BUG
经客户反映，在某些群晖的机器上出现了最新版本的驱动不正常的情况，安装上一个版本的驱动就好啦。


# 三.握手2500Mbps成功，使用异常
这里的使用异常不是指速度上不去，这个之后再说。这里的异常指蓝屏、死机、断流、掉驱动等故障。
处理方法：
## 如果是Win系统
请参照[https://flatworm-unique.chiphello.com/2021/06/usb2.5g-installation-instruction/](https://flatworm-unique.chiphello.com/2021/06/usb2.5g-installation-instruction/) 安装驱动。
## 如果是群晖
请安装上一版本驱动。
## 如果问题依旧
请用前言中的替换法，把网卡插到另一台电脑上测试，以判断是否网卡本身的问题。

# 四.握手2500Mbps成功，使用无异常，可是速度达不到预期
这个问题相对复杂，我们来有逻辑的直面这个问题。

## 测速的2块硬盘（上传盘和下载盘）速度能达到280MB/s吗
现代的机械硬盘均速在150-220MB/s，如果您的测速落在这个区间，那么可能是这个原因。
![harddiskspeed.png](/images/posts/networkcard/harddiskspeed.png)

如图所示，当年，这些都是机械硬盘中的翘楚了，速度都不到200MB/s，如今高端大容量硬盘比如10T氦气盘、12T西数拆机盘，瞬时的最高速度已经可以上到280MB/s，可是机械硬盘的速度不是恒定的，读写内圈的速度小于读写外圈的速度，这个道理大家应该懂得吧，所以这个最高速度是读写外圈测得的结果，要说均速，是远小于280MB/s的，这么一来，机械硬盘速度又成为了瓶颈。

SSD固态硬盘，则不存在这个问题，所以您如果测试极限速度的话，不妨用2块固态硬盘。当然，用多块机械硬盘组成Raid 0也是可以的。

## 测速文件请选用封装好的大文件
因为SSD有寻址损耗，机械盘有大量寻道动作，大量的零碎文件传输时不能正确的反映局域网速度。
所以测速请选用蓝光原盘、操作系统镜像等大文件。

## 缓存对速度的影响

<img width="553" alt="缓存影响0" src="https://user-images.githubusercontent.com/85718974/135564564-53e52a4f-0393-4669-8fb5-bf719df613f1.png">

<img width="586" alt="缓存影响" src="https://user-images.githubusercontent.com/85718974/135564548-01d896f5-320a-4f27-92b6-84d4ffb30cd6.png">

先看看上面的图，局域网内复制的时候，速度从开始稳定在满速，从某个时点开始断崖式下跌，之后稳定在125MB/s的速度。

这个问题我们要这样分析，首先，网卡能跑到280以上的速度，证明网卡本身是好的且驱动成功了，还可以说明交换机和NAS等设备的网络部分也是没有问题的；然后我们通过前文来排查，问题也不包含在内。那么我们着重分析缓存影响的可能性。

![20211001151417 (2)](https://user-images.githubusercontent.com/85718974/135580483-5c930edc-ccc9-46a6-8870-b5993a8806c5.jpg)

如果所示，在我们进行把NAS的数据复制到PC操作时（这里我们假定PC的硬盘是一块速度大于280Mbps的SSD），数据会预读取进入缓存中，当我们进行粘贴操作时，数据会从缓存中开始通过网络传输，缓存可以看作是一块固态硬盘或者本身就是块固态硬盘，传输的速度自然是非常的快，可以吃透2.5G局域网上限，但是，如果我们的硬盘的读取速度低于局域网内的速度，那么缓存里的数据会随着这个过程的进行而慢慢的减少；当时间来到缓存的数据被取完的那个瞬间，传输速度就会出现断崖式下跌，最后稳定的就是硬盘的真实速度。

反过来，如果PC向NAS中传输数据也会有此现象。

## 请采用内网测速的方式

请不要用“测速网、星空极速、电脑管家”等工具来测得局域网速度，这类工具测得是您的电脑到广域网（电信运营商测速服务器）之间的速度，也就是说运营商给你开了多大的宽带测得就应该是多少，和这个网卡只有一毛钱的关系。


## 感谢
@wgzeyu 勘误
